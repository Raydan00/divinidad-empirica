<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sangre de Divinidad Empírica</title>

<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4b0082">
</head>

<body>

<!-- ==============================
     PANTALLA DE INICIO
=================================-->
<div id="splash-screen">
    <img src="logo.png" id="splash-logo" alt="Logo">
</div>

<!-- ==============================
     CONTENIDO PRINCIPAL
=================================-->

<header id="main-header" class="hidden">
    <h1>Sangre de Divinidad Empírica</h1>
    <button id="install-btn" class="install-btn hidden">Instalar App</button>
</header>

<nav id="nav-chapters" class="hidden"></nav>

<main id="main-content" class="hidden">
    <section id="chapter-content">
        <h2 id="chapter-title">Cargando...</h2>

        <audio id="chapter-audio" controls>
            <source id="audio-src" src="" type="audio/mpeg">
        </audio>

        <p id="chapter-text">Por favor espera.</p>
    </section>
</main>

<script>
/* --------------------------------
   PANTALLA DE INICIO
-----------------------------------*/
const splash = document.getElementById("splash-screen");
const header = document.getElementById("main-header");
const nav = document.getElementById("nav-chapters");
const main = document.getElementById("main-content");

splash.addEventListener("click", () => {
    splash.classList.add("fade-out");
    setTimeout(() => {
        splash.style.display = "none";
        header.classList.remove("hidden");
        nav.classList.remove("hidden");
        main.classList.remove("hidden");
    }, 900);
});

/* --------------------------------
   CARGA DE CAPÍTULOS
-----------------------------------*/
let chapters = [];
let currentChapter = 0;

fetch('chapters.json')
    .then(resp => resp.json())
    .then(data => {
        chapters = data;
        createButtons();
        showChapter(0);
    });

function createButtons() {
    chapters.forEach((chap, index) => {
        const btn = document.createElement('button');
        btn.textContent = chap.title;
        btn.onclick = () => showChapter(index);
        nav.appendChild(btn);
    });
}

function showChapter(index) {
    if(index < 0 || index >= chapters.length) return;
    currentChapter = index;

    const chap = chapters[index];
    document.getElementById('chapter-title').textContent = chap.title;

    const audioSrc = document.getElementById('audio-src');
    audioSrc.src = chap.audio;
    document.getElementById('chapter-audio').load();

    fetch(chap.text)
        .then(resp => resp.text())
        .then(text => {
            document.getElementById('chapter-text').textContent = text;
        });
}

/* --------------------------------
   BOTÓN DE INSTALAR APP
-----------------------------------*/
let deferredPrompt;
const installBtn = document.getElementById("install-btn");

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.classList.remove("hidden");
});

installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    deferredPrompt = null;
});
</script>

</body>
</html>
